/*
  Arduino Nano ESP32 - Animated Weather Station
  Display: GME12864 (SSD1306/SH1106) via U8g2
  API: OpenWeatherMap (Imperial Units)
*/

#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <U8g2lib.h>
#include <Wire.h>

// ------------------- CONFIGURATION -------------------
const char* ssid     = "WIFI NETWORK NAME";
const char* password = "WIFI NETWORK PASSWORD";
const char* apiKey   = "OPENWEATHERMAP API KEY";
const char* city     = "Buffalo";
const char* country  = "US";

// Timers
unsigned long lastWeatherTime = 0;
unsigned long weatherInterval = 300000; // 5 minutes

unsigned long lastFrameTime = 0;
unsigned long frameInterval = 500;      // Animation speed (500ms)

// Display Setup
U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0, U8X8_PIN_NONE);

// Global Variables
String weatherDescription = "Connecting...";
String weatherMain = "Clear";
float temperature = 0.0;
int humidity = 0;
int currentFrame = 0; // 0 or 1

// ------------------- ANIMATION FRAMES (32x32) -------------------

// --- SUN (Rays expand/contract) ---
const unsigned char sun_f1[] U8X8_PROGMEM = {
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,
  0x00,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x10,0x10,0x00,0x00,0x08,
  0x20,0x0F,0xF0,0x04,0x40,0x3F,0xFC,0x02,0x40,0x7F,0xFE,0x02,0x00,0x7F,0xFE,0x00,
  0x80,0xFF,0xFF,0x01,0x80,0xFF,0xFF,0x01,0x80,0xFF,0xFF,0x01,0x80,0xFF,0xFF,0x01,
  0x00,0x7F,0xFE,0x00,0x40,0x7F,0xFE,0x02,0x40,0x3F,0xFC,0x02,0x20,0x0F,0xF0,0x04,
  0x10,0x00,0x00,0x08,0x08,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x01,0x80,0x00,
  0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
const unsigned char sun_f2[] U8X8_PROGMEM = {
  0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x02,
  0x20,0x00,0x00,0x04,0x10,0x00,0x00,0x08,0x00,0x0F,0xF0,0x00,0x08,0x3F,0xFC,0x10,
  0x04,0x7F,0xFE,0x20,0x04,0x7F,0xFE,0x20,0x00,0x7F,0xFE,0x00,0x00,0xFF,0xFF,0x00,
  0x00,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0x00,0x00,0x7F,0xFE,0x00,
  0x04,0x7F,0xFE,0x20,0x04,0x7F,0xFE,0x20,0x08,0x3F,0xFC,0x10,0x00,0x0F,0xF0,0x00,
  0x10,0x00,0x00,0x08,0x20,0x00,0x00,0x04,0x40,0x00,0x00,0x02,0x00,0x00,0x00,0x00,
  0x00,0x01,0x80,0x00,0x00,0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

// --- RAIN (Drops fall) ---
const unsigned char rain_f1[] U8X8_PROGMEM = {
  // Cloud base + Drops High
  0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0xFE,0x01,0x00,
  0x00,0xFF,0x03,0x00,0x80,0xFF,0x07,0x00,0xC0,0xFF,0x0F,0x00,0xE0,0xFF,0x0F,0x00,
  0xF0,0xFF,0x1F,0x00,0xF8,0xFF,0x3F,0x00,0xFC,0xFF,0x7F,0x00,0xFE,0xFF,0x7F,0x00,
  0xFE,0xFF,0xFF,0x0F,0xFF,0xFF,0xFF,0x1F,0xFF,0xFF,0xFF,0x3F,0xFF,0xFF,0xFF,0x3F,
  0xFE,0xFF,0xFF,0x1F,0xFC,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,0x04,0x80,0x02,0x00,
  0x08,0x00,0x20,0x00,0x00,0x01,0x00,0x08,0x02,0x02,0x00,0x10,0x00,0x00,0x10,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
const unsigned char rain_f2[] U8X8_PROGMEM = {
  // Cloud base + Drops Low
  0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0xFE,0x01,0x00,
  0x00,0xFF,0x03,0x00,0x80,0xFF,0x07,0x00,0xC0,0xFF,0x0F,0x00,0xE0,0xFF,0x0F,0x00,
  0xF0,0xFF,0x1F,0x00,0xF8,0xFF,0x3F,0x00,0xFC,0xFF,0x7F,0x00,0xFE,0xFF,0x7F,0x00,
  0xFE,0xFF,0xFF,0x0F,0xFF,0xFF,0xFF,0x1F,0xFF,0xFF,0xFF,0x3F,0xFF,0xFF,0xFF,0x3F,
  0xFE,0xFF,0xFF,0x1F,0xFC,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x40,0x01,0x00,0x04,0x00,0x10,0x00,0x00,0x00,0x00,0x04,0x01,0x01,0x00,0x08,
  0x00,0x00,0x08,0x00,0x00,0x10,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00
};

// --- CLOUDS (Bobbing up/down) ---
// Re-using Rain F1/F2 cloud parts but without drops for simplicity. 
const unsigned char cloud_static[] U8X8_PROGMEM = {
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x7C,0x00,0x00,
  0x00,0xFE,0x01,0x00,0x00,0xFF,0x03,0x00,0x80,0xFF,0x07,0x00,0xC0,0xFF,0x0F,0x00,
  0xE0,0xFF,0x0F,0x00,0xF0,0xFF,0x1F,0x00,0xF8,0xFF,0x3F,0x00,0xF8,0xFF,0x3F,0x00,
  0xFC,0xFF,0x7F,0x00,0xFE,0xFF,0x7F,0x00,0xFE,0xFF,0xFF,0x0F,0xFF,0xFF,0xFF,0x1F,
  0xFF,0xFF,0xFF,0x3F,0xFF,0xFF,0xFF,0x3F,0xFF,0xFF,0xFF,0x3F,0xFE,0xFF,0xFF,0x1F,
  0xFC,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

// --- THUNDER (Bolt Flashing) ---
const unsigned char thunder_f1[] U8X8_PROGMEM = {
  // Cloud Only
  0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0xFE,0x01,0x00,
  0x00,0xFF,0x03,0x00,0x80,0xFF,0x07,0x00,0xC0,0xFF,0x0F,0x00,0xE0,0xFF,0x0F,0x00,
  0xF0,0xFF,0x1F,0x00,0xF8,0xFF,0x3F,0x00,0xFC,0xFF,0x7F,0x00,0xFE,0xFF,0x7F,0x00,
  0xFE,0xFF,0xFF,0x0F,0xFF,0xFF,0xFF,0x1F,0xFF,0xFF,0xFF,0x3F,0xFF,0xFF,0xFF,0x3F,
  0xFF,0xFF,0xFF,0x3F,0xFE,0xFF,0xFF,0x1F,0xFC,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};
const unsigned char thunder_f2[] U8X8_PROGMEM = {
  // Cloud + Bolt
  0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0xFE,0x01,0x00,
  0x00,0xFF,0x03,0x00,0x80,0xFF,0x07,0x00,0xC0,0xFF,0x0F,0x00,0xE0,0xFF,0x0F,0x00,
  0xF0,0xFF,0x1F,0x00,0xF8,0xFF,0x3F,0x00,0xFC,0xFF,0x7F,0x00,0xFE,0xFF,0x7F,0x00,
  0xFE,0xFF,0xFF,0x0F,0xFF,0xFF,0xFF,0x1F,0xFF,0xFF,0xFF,0x3F,0xFF,0xFF,0xFF,0x3F,
  0xFF,0xFF,0xFF,0x3F,0xFE,0xFF,0xFF,0x1F,0xFC,0xFF,0xFF,0x0F,0x00,0x00,0x00,0x00,
  0x00,0x00,0x0E,0x00,0x00,0x00,0x1C,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x70,0x00,
  0x00,0x00,0xE0,0x00,0x00,0x03,0xFF,0x00,0x00,0x00,0x70,0x00,0x00,0x00,0x38,0x00
};

// ------------------- MAIN CODE -------------------

void setup() {
  Serial.begin(115200);
  u8g2.begin();
  u8g2.setFont(u8g2_font_profont12_tf);
  
  u8g2.clearBuffer();
  u8g2.setCursor(0, 20);
  u8g2.print("Connecting WiFi...");
  u8g2.sendBuffer();

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi connected.");
  
  fetchWeatherData();
}

void loop() {
  unsigned long currentMillis = millis();

  // 1. Fetch Weather Data (Every 5 mins)
  if ((currentMillis - lastWeatherTime) > weatherInterval) {
    if(WiFi.status() == WL_CONNECTED){
      fetchWeatherData();
    }
    lastWeatherTime = currentMillis;
  }

  // 2. Animation Logic (Every 500ms)
  if ((currentMillis - lastFrameTime) > frameInterval) {
    currentFrame = !currentFrame; // Toggle 0 -> 1 -> 0
    updateDisplay();              // Redraw screen with new frame
    lastFrameTime = currentMillis;
  }
}

void fetchWeatherData() {
  WiFiClient client;
  HTTPClient http;
  
  String serverPath = "http://api.openweathermap.org/data/2.5/weather?q=" + String(city) + "," + String(country) + "&appid=" + String(apiKey) + "&units=imperial";
  
  http.begin(client, serverPath);
  int httpResponseCode = http.GET();
  
  if (httpResponseCode > 0) {
    String payload = http.getString();
    JsonDocument doc;
    DeserializationError error = deserializeJson(doc, payload);

    if (!error) {
      temperature = doc["main"]["temp"];
      humidity = doc["main"]["humidity"];
      weatherDescription = doc["weather"][0]["description"].as<String>();
      weatherMain = doc["weather"][0]["main"].as<String>();
    } else {
      Serial.println(error.c_str());
    }
  }
  http.end();
}

void updateDisplay() {
  u8g2.clearBuffer();
  
  // --- Animation Selector ---
  const unsigned char* iconToDraw;

  if (weatherMain == "Thunderstorm") {
    iconToDraw = (currentFrame == 0) ? thunder_f1 : thunder_f2;
  } 
  else if (weatherMain == "Drizzle" || weatherMain == "Rain") {
    iconToDraw = (currentFrame == 0) ? rain_f1 : rain_f2;
  } 
  else if (weatherMain == "Snow") {
    // Re-use rain drops for snow logic for simplicity in this example
    // Or you can create a separate snow_f1/f2 array similar to rain
    iconToDraw = (currentFrame == 0) ? rain_f1 : rain_f2; 
  } 
  else if (weatherMain == "Clouds" || weatherMain == "Mist" || weatherMain == "Fog") {
    iconToDraw = cloud_static; // No animation for plain clouds
  } 
  else {
    // Clear/Sun/Default
    iconToDraw = (currentFrame == 0) ? sun_f1 : sun_f2;
  }
  
  // Draw Icon
  u8g2.drawXBMP(5, 16, 32, 32, iconToDraw);
  
  // Draw Text
  u8g2.setFont(u8g2_font_helvB14_tf); 
  u8g2.setCursor(45, 30);
  u8g2.print(temperature, 1);
  u8g2.print(" F"); 
  
  u8g2.setFont(u8g2_font_profont12_tf); 
  u8g2.setCursor(45, 45);
  u8g2.print("Hum: ");
  u8g2.print(humidity);
  u8g2.print("%");
  
  u8g2.setCursor(5, 60);
  String shortDesc = weatherDescription;
  if(shortDesc.length() > 20) shortDesc = shortDesc.substring(0, 20);
  if(shortDesc.length() > 0) shortDesc[0] = toupper(shortDesc[0]);
  u8g2.print(shortDesc); 
  
  u8g2.sendBuffer();
}
